#endregion functions

$WiredAdapter = Get-CimInstance -Namespace root\WMI -Class MSNdis_PhysicalMediumType -Filter `
    "NdisPhysicalMediumType = 0 and `
    (NOT InstanceName like '%TAP-Windows%') and `
    (NOT InstanceName like '%Virtual Ethernet%') and `
    (NOT InstanceName like '%pangp%') and `
    (NOT InstanceName like '%cisco%') and `
    (NOT InstanceName like '%juniper%') and `
    (NOT InstanceName like '%vpn%') and `
    (NOT InstanceName like 'Hyper-V%') and `
    (NOT InstanceName like 'VMware%') and `
    (NOT InstanceName like 'VirtualBox Host-Only%')" | ? { $_.Active -eq $true }

$WirelessAdapter = Get-CimInstance -Namespace root\wmi -Class MSNdis_PhysicalMediumType -Filter "NdisPhysicalMediumType=9 OR NdisPhysicalMediumType=1" | `
Where-Object { $_.InstanceName -notmatch "virtual" -and $_.Active -eq $true }

# in case, that Internet connection isn't available and there is WIFI adapter, offer it for connection
"Checking Internet connection..it can take up to one minute"
while (-NOT (Test-WebConnection -Uri $GitHubBaseUrl)) {
    Write-Warning "Could not verify an Internet connection to $GitHubBaseUrl"

    if ($WirelessAdapter) {
        # WIFI adapter exists

        $SSIDList = Get-AvailableWiFiNetwork
        if ($SSIDList) {
            #show list of available SSID
            $SSIDList | Sort-Object SSID | Format-Table

            $SSIDListIndex = $SSIDList.index
            $SSIDIndex = ""
            while ($SSIDIndex -notin $SSIDListIndex) {
                $SSIDIndex = Read-Host "Select index of WIFI network to connect"
            }

            $SSID = $SSIDList | Where-Object { $_.index -eq $SSIDIndex } | Select-Object -exp SSID

            # connect to selected WIFI
            try {
                "Connecting $SSID"
                Connect-WiFiNetwork $SSID -ErrorAction Stop
            } catch {
                Write-Warning $_
                continue
            }
        } else {
            if ($WiredAdapter) {
                Write-Warning "No WIFI network found. Move closer to AP or use ethernet cable instead."
            } else {
                Write-Warning "No WIFI network found"
            }
        }
    } else {
        if ($WiredAdapter) {
            Write-Warning "There is no WIFI adapter available. Use ethernet cable instead."
        } else {
            throw "There is no WIFI nor WIRED adapter available. Try to import different drivers to this WinPE?"
        }
    }

    # connection to network can take a while
    $i = 30
    while (-NOT (Test-WebConnection -Uri $GitHubBaseUrl) -and $i -gt 0) { --$i; "Waiting for Internet connection ($i)" ; sleep 1 }
}
#endregion